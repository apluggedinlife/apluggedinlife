{% load markup i18n mptt_tags mptt_comments_tags comparison %}

{% for comment, tree in comments|tree_info %}

{% if not tree.new_level %}</article>{% endif %}

<article class="comment comment-level-{{ comment.level }}{% if_greater comment.level collapse_levels_above %} comment-collapsed{% endif_greater %}" id="comment-{{ comment.pk }}">
    <header>
        <p class="comment-title"><a class="comment-expand" href="{% url comment-detail comment.pk %}">{{ comment.title }}</a></p>
        <p class="comment-meta">
            <span class="comment-author">{% trans "Commented by" %} {{ comment.name }}</span>
            <time datetime="{{ comment.submit_date }}">
                {{ comment.submit_date|date:"l" }}{{ comment.submit_date|date:"j F" }} {% trans "at" %} {{ comment.submit_date|date:"H:i" }}
            </time>
        </p>
    </header>
    

    <div class="comment-body {% if_less comment.level collapse_levels_below %} comment-collapsed-below{% endif_less %}">
    
        {{ comment.comment|markdown }}

         <p>
            {% if comment|children_count %}{% ifequal comment.level cutoff_level %}
                <a class="comment-replies" href="{% url comments-subtree comment.pk %}">
                    {{ comment|children_count }} {% trans "hidden replies" %}
                </a>
            {% else %}
                {{ comment|children_count }} {% trans "replies" %}
            {% endifequal %} |{% endif %}
             <a class="comment-post-new" href="#post_new_comment">
                {% trans "Post a new comment" %}
            </a> |
            <a class="comment-reply" href="{% url comment-reply comment.pk %}">
                {% trans "Reply to this comment" %}
            </a>
        </p>
    </div>

{% for level in tree.closed_levels %}

    {% if forloop.parentloop.last %}
        {# not the topmost tree, skip closing some levels #}         
        {% if_greater level bottom_level %}</article>{% endif_greater %}
    {% else %}
        </article>
    {% endif %}

{% endfor %}

{% endfor %}   
